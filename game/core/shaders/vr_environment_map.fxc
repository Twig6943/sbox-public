// Copyright (c) Valve Corporation, All rights reserved. ======================================================================================================

#ifndef VR_ENVIRONMENT_MAP_FXC
#define VR_ENVIRONMENT_MAP_FXC

// Includes ---------------------------------------------------------------------------------------------------------------------------------------------------
#include "system.fxc"
#include "math_general.fxc"
#include "common_samplers.fxc"
#include "common/Bindless.hlsl"

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

float EnvMapNumLevels( uint nEnvMap )
{
	int2 nDim;
	int nLevels;
	g_bindless_TextureCube[nEnvMap].GetDimensions( 0, nDim.x, nDim.y, nLevels );
	return nLevels;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------

float4 SampleEnvMapLevel( float3 vReflectionDirWs, float flLevel, uint nEnvMap )
{
	return g_bindless_TextureCube[nEnvMap].SampleLevel( g_sTrilinearWrap, vReflectionDirWs.xyz, flLevel * EnvMapNumLevels( nEnvMap ) ).xyzw;
}

float4 EnvMapNormalizationSH( uint nEnvMap )
{
	return BinnedEnvMapBuffer[ nEnvMap ].NormalizationSH.xyzw;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
float4x3 EnvMapWorldToLocal( uint nEnvMap )
{
	return BinnedEnvMapBuffer[ nEnvMap ].WorldToLocal;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
float3 EnvMapBoxMins( uint nEnvMap )
{
	return BinnedEnvMapBuffer[ nEnvMap ].BoxMins.xyz;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
float3 EnvMapBoxMaxs( uint nEnvMap )
{
	return BinnedEnvMapBuffer[ nEnvMap ].BoxMaxs.xyz;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
float3 EnvMapColor( uint nEnvMap )
{
	return BinnedEnvMapBuffer[ nEnvMap ].Color.xyz;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
float3 SampleEnvironmentMapLevel( float3 vReflectionDirWs, float flLevel, uint nEnvMap )
{
	float4 vEnvironmentMapTexel = SampleEnvMapLevel( vReflectionDirWs.xyz, flLevel, BinnedEnvMapBuffer[ nEnvMap ].GetCubemapIndex() ).rgba;
	return vEnvironmentMapTexel.rgb * EnvMapColor( nEnvMap );
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------
float EnvMapFeathering( uint nEnvMap )
{
	return BinnedEnvMapBuffer[ nEnvMap ].Color.w;
}

#endif // VR_ENVIRONMENT_MAP_FXC
