@using Sandbox.Modals
@using Sandbox
@using Sandbox.Network

<root>

    @if ( busy)
    {
        <div class="loading"><i>settings_ethernet</i></div>
    }
    else if (lobbies.Count == 0)
    {
        <div class="notice">Sorry - no servers were found 😔</div>
    }
    else
    {
		<div class="header row">
			<div class="title">Name</div>
			<div class="game">Game</div>
			<div class="map">Map</div>
			<div class="members">Players</div>
		</div>
        @foreach ( LobbyInformation lobby in lobbies.OrderBy(x => -x.Members) )
        {
            <ServerRow Server="@lobby"></ServerRow>
        }
    }
</root>

@code
{
    ServerListConfig Config = default;

    public IEnumerable<Friend> Friends => MenuUtility.Friends.Where( x => !x.IsMe )
        .OrderBy( x => x.Name )
        .OrderBy( x => x.IsAway || x.IsBusy || x.IsSnoozing );

    bool busy;
    List<LobbyInformation> lobbies = new();

    protected override async Task OnParametersSetAsync()
    {
        await RefreshLobbies();
    }

    public async Task RefreshLobbies()
    {
        lobbies = default;
        StateHasChanged();

        busy = true;

        var filters = new Dictionary<string, string>
        {
	        { "game", Config.GamePackageFilter },
	        { "map", Config.MapPackageFilter },
        };
        
        lobbies = await Networking.QueryLobbies( filters );
        
        busy = false;

        StateHasChanged();
    }

    void OnLobbySelected( LobbyInformation lobby )
    {
        Networking.Connect(lobby.LobbyId);
    }
}
