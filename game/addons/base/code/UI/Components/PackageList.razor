@using System;
@using Sandbox;
@using Sandbox.UI;
@using System.Threading
@namespace Sandbox.UI
@inherits Panel

<root class="package-list">

    @if ( ShowFilters )
    {
        <PackageFilters Result=@Result Query=@Query OnChange=@OnQueryUpdated></PackageFilters>
    }

    @if ( FoundPackages == null )
    {
        <LoaderFullScreen></LoaderFullScreen>
    }
    else if (FoundPackages.Count() == 0 )
    {
        <div class="loading-status">Nothing Found</div>
    }
    else
    {
        <VirtualGrid Items=@( FoundPackages ) ItemSize=@ItemSize OnLastCell=@( () => { _ = FetchMore(); } )>
            <Item Context="item">
                @if (item is Package package)
                {
                    <PackageCard OnMenu=@(() => OnMenu?.Invoke(package))
                                 OnLaunch=@(() => OnSelected?.Invoke(package))
                                 Package=@package></PackageCard>
                }
            </Item>
        </VirtualGrid>
    }
    
</root>

@code
{
    [Parameter] public string Query { get; set; }
    [Parameter] public int Take { get; set; } = 100;
    [Parameter] public bool ShowFilters { get; set; } = false;
    [Parameter] public Vector2 ItemSize => new Vector2( 260, 170 );

    [Parameter] public System.Action<Package> OnMenu { get; set; }
    [Parameter] public System.Action<Package> OnSelected { get; set; }
    [Parameter] public Action<string> OnFilterChanged { get; set; }
    [Parameter] public Package[] Packages { get; set; }

    [Parameter] public List<Package> FoundPackages { get; set; }

       public Package.FindResult Result;

    protected override async Task OnParametersSetAsync()
    {
        if (Packages is not null)
        {
            FoundPackages = new();
            FoundPackages.AddRange(Packages);
            Query = "";
            StateHasChanged();
        }

        FoundPackages = null;

        Query ??= "";

        await RunQuery();
    }

    async Task RunQuery()
    {
        var query = Query;

        Result = await Package.FindAsync(Query, Take, 0);

        if ( query != Query )
            return;

        if (Result != null)
        {
            FoundPackages = new();
            FoundPackages.AddRange(Result.Packages);
        }

        StateHasChanged();
    }

    async Task FetchMore()
    {
        if (Result == null) return;
        if (FoundPackages.Count() >= Result.TotalCount) return;

        var query = Query;

        var result = await Package.FindAsync( Query, Take, FoundPackages.Count() );

        if (query != Query)
            return;

        if (result != null)
        {
            FoundPackages.AddRange(result.Packages);
            FoundPackages = FoundPackages.ToList(); // need to make a new reference so the grid notices
            StateHasChanged();
        }
    }

    void OnQueryUpdated( string newQuery )
    {
        if (Query == newQuery)
            return;

        Query = newQuery;

        _ = RunQuery();

        OnFilterChanged?.Invoke(newQuery);
    }
}
